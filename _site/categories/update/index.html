<!DOCTYPE html>
<html lang="en">
  <head>
    <title>Roy Xing</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/bricklayer/0.4.2/bricklayer.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/bricklayer/0.4.2/bricklayer.min.js"></script>
    
    <link href="http://localhost:4000/css/styles.css" type="text/css" rel="stylesheet"></link>
    <link href="https://fonts.googleapis.com/css?family=Cutive+Mono" rel="stylesheet"> 
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,700" rel="stylesheet" type="text/css">
    <meta content="My portfolio website" name="description"></meta>
    <meta content="Roy Xing" name="author"></meta>
    <meta content="Copyright 2017 Roy Xing. All rights reserved." name="copyright"></meta>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://kit.fontawesome.com/00e49ff449.js" crossorigin="anonymous"></script>
    <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

</head>

  <body>
	<div id="main">
		<div id="logo">
  <!-- <a href="http://localhost:4000/">
    <img src="http://localhost:4000/assets/images/logo.svg" alt="Logo"></img>
  </a> -->
</div>

		<div id="nav">
  <a href="http://localhost:4000/"><h1 id="title-text" href="http://localhost:4000/">Roy Xing</h1></a>
  <div id="nav-btns-wrap">
    <a class="nav-link" href="http://localhost:4000/">About</a>
    <a class="nav-link" href="http://localhost:4000/blog">Blog</a>
    <a class="nav-link" href="http://localhost:4000/projects/">
    Projects</a>
    <a class="nav-link" href="http://localhost:4000/assets/resume.pdf" target="_blank">
    CV</a>
  </div>
</div>

		<div id="content-left">
      <h2>Category: update</h2>
      
      
        This is an example description.
      
      
        <div id="post-short">
          <a href="http://localhost:4000/2021/12/06/test-post/">
            <h3>SuperTuxKart RL Agent Jupyter Notebook</h3>
          </a>
          <i>posted on 6 Dec 2021</i>
          <p>
            
              <h3 id="just-a-test-to-put-the-jupyter-notebook-for-my-supertuxkart-rl-agent-project-into-a-blog-post">Just a test to put the Jupyter Notebook for my SuperTuxKart RL agent project into a blog post.</h3>

<p>#<strong>EC418 Fall 2022 Final Project: PPO SuperTuxKart</strong></p>

<p><strong>Goal:</strong> Get an RL agent to learn how to play SuperTuxKart by getting as far as it can on a given track.</p>

<p><strong>Approach:</strong> Proximal Policy Optimization (PPO)</p>

<p>#####<strong>Installing Dependencies</strong></p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">%</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">PySuperTuxKart</span>

<span class="c1"># Hide Output with '&gt; /dev/null 2&gt;&amp;1'
</span><span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">!</span><span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="o">-</span><span class="n">y</span> <span class="n">xvfb</span> <span class="n">python</span><span class="o">-</span><span class="n">opengl</span> <span class="n">ffmpeg</span> <span class="n">xvfbwrapper</span> <span class="n">cmake</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pyvirtualdisplay</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">pyglet</span><span class="o">==</span><span class="mf">1.5</span><span class="p">.</span><span class="mi">27</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span> <span class="c1"># newer versions deprecate functions we need
</span><span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">ez_setup</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">gym</span><span class="o">==</span><span class="mf">0.21</span><span class="p">.</span><span class="mi">0</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="o">-</span><span class="n">U</span> <span class="n">ray</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>
<span class="err">!</span><span class="n">pip</span> <span class="n">install</span> <span class="n">imageio</span><span class="o">==</span><span class="mf">2.4</span><span class="p">.</span><span class="mi">1</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">null</span> <span class="mi">2</span><span class="o">&gt;&amp;</span><span class="mi">1</span>



<span class="c1">#####**Mounting to Drive for Saving Results**
</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="kn">from</span> <span class="nn">google.colab</span> <span class="kn">import</span> <span class="n">drive</span>
<span class="n">drive</span><span class="p">.</span><span class="n">mount</span><span class="p">(</span><span class="s">'/content/drive/'</span><span class="p">,</span> <span class="n">force_remount</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="o">%</span><span class="n">cd</span> <span class="o">/</span><span class="n">content</span><span class="o">/</span><span class="n">drive</span><span class="o">/</span><span class="n">MyDrive</span><span class="o">/</span>
<span class="err">!</span><span class="n">ls</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Mounted at /content/drive/
/content/drive/MyDrive
 500_epoch.mp4	    controller.th	     Pictures	   result3.mp4
 Archive	    hacienda_controller.th   result1.mp4   snowtuxpeak.mp4
'Colab Notebooks'   hacienda.mp4	     result2.mp4   __temp__.mp4
</code></pre></div></div>

<p>####<strong>Utils</strong></p>

<p>#####prepare_video function based on WandBâ€™s video data source:</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">from</span> <span class="nn">moviepy.editor</span> <span class="kn">import</span> <span class="n">ImageSequenceClip</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="k">def</span> <span class="nf">prepare_video</span><span class="p">(</span><span class="n">video</span><span class="p">:</span> <span class="s">"np.ndarray"</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s">"np.ndarray"</span><span class="p">:</span>
        <span class="s">"""This logic was mostly taken from tensorboardX"""</span>
        <span class="k">if</span> <span class="n">video</span><span class="p">.</span><span class="n">ndim</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">:</span>
            <span class="k">raise</span> <span class="nb">ValueError</span><span class="p">(</span>
                <span class="s">"Video must be atleast 4 dimensions: time, channels, height, width"</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">video</span><span class="p">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">*</span><span class="n">video</span><span class="p">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">video</span><span class="p">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="n">video</span><span class="p">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">:</span>
            <span class="c1">#logging.warning("Converting video data to uint8")
</span>            <span class="n">video</span> <span class="o">=</span> <span class="n">video</span><span class="p">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_power2</span><span class="p">(</span><span class="n">num</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">num</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">((</span><span class="n">num</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">num</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="c1"># pad to nearest power of 2, all at once
</span>        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_power2</span><span class="p">(</span><span class="n">video</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">len_addition</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">video</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="n">video</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">video</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">concatenate</span><span class="p">(</span>
                <span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shape</span><span class="o">=</span><span class="p">(</span><span class="n">len_addition</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span>
            <span class="p">)</span>

        <span class="n">n_rows</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">**</span> <span class="p">((</span><span class="n">b</span><span class="p">.</span><span class="n">bit_length</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">n_cols</span> <span class="o">=</span> <span class="n">video</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">n_rows</span>

        <span class="n">video</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">newshape</span><span class="o">=</span><span class="p">(</span><span class="n">n_rows</span><span class="p">,</span> <span class="n">n_cols</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span><span class="p">))</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="n">video</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">newshape</span><span class="o">=</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">n_rows</span> <span class="o">*</span> <span class="n">h</span><span class="p">,</span> <span class="n">n_cols</span> <span class="o">*</span> <span class="n">w</span><span class="p">,</span> <span class="n">c</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">video</span>



<span class="c1">#####make_video function based on the rollout data
</span>

<span class="sb">``</span><span class="err">`</span><span class="n">python</span>
<span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Video</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>

<span class="k">def</span> <span class="nf">make_video</span><span class="p">(</span><span class="n">rollouts</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">videos</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">max_t</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="n">rollouts</span><span class="p">:</span>
        <span class="n">video</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">rollout</span><span class="p">:</span>
            <span class="n">video</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">s</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

        <span class="n">videos</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">(</span><span class="n">video</span><span class="p">))</span>
        <span class="n">max_t</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">max_t</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">rollout</span><span class="p">))</span>

    <span class="n">videos</span><span class="p">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">w</span> <span class="o">=</span> <span class="n">videos</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">shape</span>
    <span class="n">full</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">max_t</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">m</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="n">m</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">)</span>

    <span class="c1"># blocking up the videos to view multiple at the same time
</span>    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">m</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">j</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">videos</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">videos</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">j</span><span class="p">].</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">full</span><span class="p">[:</span><span class="n">n</span><span class="p">,</span> <span class="p">:,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">h</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">w</span><span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">videos</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span>
            <span class="n">full</span><span class="p">[</span><span class="n">n</span><span class="p">:,</span> <span class="p">:,</span> <span class="n">i</span> <span class="o">*</span> <span class="n">h</span><span class="p">:</span> <span class="n">i</span> <span class="o">*</span> <span class="n">h</span> <span class="o">+</span> <span class="n">h</span><span class="p">,</span> <span class="n">j</span> <span class="o">*</span> <span class="n">w</span><span class="p">:</span> <span class="n">j</span> <span class="o">*</span> <span class="n">w</span> <span class="o">+</span> <span class="n">w</span><span class="p">]</span> <span class="o">=</span> <span class="n">videos</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="n">m</span> <span class="o">+</span> <span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="bp">None</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">full</span>
</code></pre></div></div>

<p>#####simple geometry functions for getting distance for calc supertuxkart data in rollout</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">point_from_line</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">):</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">p</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">u</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">u</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">b</span> <span class="o">-</span> <span class="n">a</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]])</span>
    <span class="n">v_norm</span> <span class="o">=</span> <span class="n">v</span> <span class="o">/</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
    <span class="n">close</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_norm</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_norm</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="n">close</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_distance</span><span class="p">(</span><span class="n">d_new</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">track_length</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">d_new</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">d_new</span> <span class="o">&lt;</span> <span class="n">d</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">d_new</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">d_new</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">d_new</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sign</span> <span class="o">*</span> <span class="p">((</span><span class="n">d_new</span> <span class="o">-</span> <span class="n">d</span><span class="p">)</span> <span class="o">%</span> <span class="n">track_length</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d_new</span> <span class="o">-</span> <span class="n">d</span>
</code></pre></div></div>

<p>#<strong>Reinforcement Learning for SuperTuxKart</strong></p>

<p>#####<strong>Neural Network Declaration for actor &amp; critic network</strong>
<strong>actor</strong> - model performs the task of learning what action to take under state observation of the environment.</p>

<p><strong>critic</strong> - evaluate if the action taken leads to a better state or not. Outputs a rating (Q-value) of action taken in the previous state.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="n">F</span>

<span class="k">class</span> <span class="nc">Network</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">().</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">n_outputs</span> <span class="o">=</span> <span class="n">n_outputs</span>

        <span class="c1"># BatchNorm to help stabilize network during training [ref: https://towardsdatascience.com/batch-norm-explained-visually-how-it-works-and-why-neural-networks-need-it-b18919692739]
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">norm</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># 2D since we want to look at the screenshots
</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>
                                     <span class="n">kernel_size</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv3</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">fc4</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">64</span><span class="p">,</span> <span class="mi">512</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">fc5</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="n">n_outputs</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="bp">True</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv3</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">fc4</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)))</span> <span class="c1"># reshaping tensor w/o copy
</span>        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">fc5</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

    <span class="k">def</span> <span class="nf">get_output_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">n_outputs</span>

</code></pre></div></div>

<p>#####<strong>Discretized Policy</strong>
Includes possible actions that the agent (actor) may take to drive the kart</p>

<p><strong>NOTE</strong>: might need to change max acceleration</p>

<p>[ ref: https://arxiv.org/pdf/1901.10500.pdf ]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">import</span> <span class="nn">pystk</span>
<span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>


<span class="k">class</span> <span class="nc">BasePolicy</span><span class="p">:</span>
    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">m</span><span class="p">:</span> <span class="n">Dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="nb">NotImplementedError</span><span class="p">(</span><span class="s">"__call__ in class BasePolicy"</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">DiscretizedPolicy</span><span class="p">():</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">neural_net</span><span class="p">,</span> <span class="n">n_actions</span><span class="p">,</span> <span class="n">eps</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">n_actions</span> <span class="o">=</span> <span class="n">n_actions</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">neural_net</span> <span class="o">=</span> <span class="n">neural_net</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">neural_net</span><span class="p">.</span><span class="nb">eval</span><span class="p">().</span><span class="n">cpu</span><span class="p">()</span> <span class="c1"># turn off BatchNorm layer for model eval &amp;&amp; move tensor to CPU mem
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span> <span class="c1"># based on current epoch being iterated on eps = np.clip((1 - epoch / 100) * self.eps, 0.0, 1.0) on a higher level
</span>
    <span class="c1"># function that enables the class to behave like a function when called
</span>    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">Q</span><span class="p">):</span>
        <span class="c1"># detach gradients attached to tensors
</span>        <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="c1"># flatten it out
</span>            <span class="n">state</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">state</span><span class="p">).</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">cpu</span><span class="p">()</span> <span class="c1"># move to CPU mem
</span>            <span class="c1"># create a categorical distribution with event log probabilities (logits)
</span>            <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">distributions</span><span class="p">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">neural_net</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="p">.</span><span class="n">eps</span><span class="p">:</span>
            <span class="n">action_indx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">n_actions</span><span class="p">)))</span> <span class="c1"># random exploration
</span>        <span class="k">else</span><span class="p">:</span>
            <span class="n">action_indx</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">sample</span><span class="p">().</span><span class="n">item</span><span class="p">()</span> <span class="c1"># sample a event distribution for action index
</span>
        <span class="c1"># probability of action for a event state
</span>        <span class="n">p</span> <span class="o">=</span> <span class="n">m</span><span class="p">.</span><span class="n">probs</span><span class="p">.</span><span class="n">squeeze</span><span class="p">()[</span><span class="n">action_indx</span><span class="p">]</span>
        <span class="n">p_action</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">eps</span><span class="p">)</span> <span class="o">*</span> <span class="n">p</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">eps</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>
        <span class="c1"># 4 actions include: steer left Y|N, steer right Y|N, accelerate Y|N, drifting Y|N
</span>        <span class="n">action</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">()</span>

        <span class="c1"># turn action_indx into a 4 digit binary that corresponds to which of the 4 main actions
</span>        <span class="c1"># and if we should do said action or not
</span>        <span class="c1"># 16 possible actions -&gt; can be rep by 1111b
</span>        <span class="n">binary</span> <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">action_indx</span><span class="p">).</span><span class="n">lstrip</span><span class="p">(</span><span class="s">'0b'</span><span class="p">).</span><span class="n">rjust</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="s">'0'</span><span class="p">)</span>

        <span class="c1"># digit x___ determines if steer left (-1.0) -&gt; NOTE: a little less of a sharp turn now
</span>        <span class="c1"># digit _x__ determines if steer right (1.0)
</span>        <span class="c1"># TODO: base this on Q like how acceleration is for more fidelity! -&gt; maybe can handle higher accels?
</span>        <span class="k">if</span> <span class="p">(</span><span class="n">binary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">):</span>
            <span class="c1"># steer to the left
</span>            <span class="n">action</span><span class="p">.</span><span class="n">steer</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">binary</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">)</span> <span class="o">*</span> <span class="mf">25.0</span> <span class="o">-</span> <span class="n">Q</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">binary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">):</span>
            <span class="c1"># steer to the right
</span>            <span class="n">action</span><span class="p">.</span><span class="n">steer</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">binary</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">)</span> <span class="o">*</span> <span class="mf">25.0</span> <span class="o">-</span> <span class="n">Q</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
        <span class="c1">#action.steer = int(binary[0] == '1') * -1.0 + int(binary[1] == '1') * 1.0 # OG
</span>
        <span class="c1"># NOTE: the system usually will go with the max value though
</span>        <span class="c1"># digit __x_ determines acceleration value based on Q clipped to range [0.0, 0.5]
</span>        <span class="c1"># kind of arbitrarily calculated but varied by Q (high reward -&gt; accelerate more)
</span>        <span class="n">action</span><span class="p">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="mi">5</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">binary</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">)</span> <span class="o">*</span> <span class="mf">20.0</span> <span class="o">-</span> <span class="n">Q</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
        <span class="c1">#action.acceleration = np.clip(5 + int(binary[2] == '1') * 20.0 - Q, 0, 0.5) # OG
</span>
        <span class="c1"># digit ___x determines drift boolean value
</span>        <span class="n">action</span><span class="p">.</span><span class="n">drift</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">binary</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="s">'1'</span><span class="p">)</span>
        <span class="c1"># NOTE: for increasing performance, might want to action.brake = True before drifting
</span>
        <span class="k">return</span> <span class="n">action</span><span class="p">,</span> <span class="n">action_indx</span><span class="p">,</span> <span class="n">p_action</span>
</code></pre></div></div>

<p>####<strong>PPO Implementation</strong>
<strong>PPO-clip</strong> version is used here as described in the following references:</p>

<p>[https://spinningup.openai.com/en/latest/algorithms/ppo.html ]</p>

<p>[https://medium.com/analytics-vidhya/coding-ppo-from-scratch-with-pytorch-part-1-4-613dfc1b14c8 ]</p>

<p>[https://arxiv.org/pdf/1707.06347.pdf ]</p>

<p>[https://stats.stackexchange.com/questions/326608/why-is-ppo-able-to-train-for-multiple-epochs-on-the-same-minibatch ]</p>

<p><strong>Actor-Critic Framework</strong>
[https://tinyurl.com/435cyyn8 ]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torch.optim</span> <span class="kn">import</span> <span class="n">Adam</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="n">np</span>

<span class="k">class</span> <span class="nc">PPO</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="p">,</span> <span class="n">learn_r</span><span class="p">,</span> <span class="n">iters</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">clip</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span> <span class="c1"># needed for Ray trainer
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="n">batch_size</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">learn_r</span> <span class="o">=</span> <span class="n">learn_r</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">iters</span> <span class="o">=</span> <span class="n">iters</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">eps</span> <span class="o">=</span> <span class="n">eps</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">gamma</span> <span class="o">=</span> <span class="n">gamma</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">clip</span> <span class="o">=</span> <span class="n">clip</span> <span class="c1"># the epsilon from algo step 6
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">n_actions</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">4</span> <span class="c1"># hardcoded from the DiscretizedPolicy, probably not best practices
</span>
    <span class="c1"># actor model
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">actor</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">n_actions</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">actor</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># mem format for desired device
</span>    <span class="c1"># optimizer for actor
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">optimr_actor</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">actor</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">learn_r</span><span class="p">)</span>

    <span class="c1"># critic model
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">critic</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># only one output for criticizing actor i.e. TD error
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">critic</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
    <span class="c1"># optimizer for critic
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">optimr_critic</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">optim</span><span class="p">.</span><span class="n">Adam</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">critic</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">learn_r</span><span class="p">)</span>

  <span class="c1"># return the action, action_indx, p_action from the discretized policy based on actor model
</span>  <span class="k">def</span> <span class="nf">get_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">DiscretizedPolicy</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">actor</span><span class="p">,</span>
                             <span class="n">n_actions</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">n_actions</span><span class="p">,</span>
                             <span class="n">eps</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">epoch</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="p">.</span><span class="n">eps</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)))</span>


  <span class="c1"># where the PPO learning magic is!
</span>  <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">replay</span><span class="p">):</span>
    <span class="c1"># prepare the nns' losses
</span>    <span class="n">losses_actor</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">losses_critic</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

    <span class="c1"># format/send nns to specified device mem
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">actor</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">critic</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>

    <span class="c1"># training the actor and critic models
</span>    <span class="bp">self</span><span class="p">.</span><span class="n">actor</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="bp">self</span><span class="p">.</span><span class="n">critic</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>

    <span class="c1"># main PPO-clip algorithm
</span>    <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">iters</span><span class="p">):</span>
      <span class="c1"># choose a random point in the replay buffer to analyze
</span>      <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">random</span><span class="p">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">replay</span><span class="p">),</span> <span class="bp">self</span><span class="p">.</span><span class="n">batch_size</span><span class="p">)</span>
      <span class="n">s</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">p_i</span><span class="p">,</span> <span class="n">p_k</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="n">replay</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>

      <span class="c1"># format/send tensors to specified device mem
</span>      <span class="n">s</span>   <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">transpose</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)).</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># state (i.e. observed batch)
</span>      <span class="n">p_i</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">LongTensor</span><span class="p">(</span><span class="n">p_i</span><span class="p">).</span><span class="n">squeeze</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>  <span class="c1"># current policy params
</span>      <span class="n">p_k</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">p_k</span><span class="p">).</span><span class="n">squeeze</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># prev_policy params
</span>      <span class="n">Q</span>   <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">FloatTensor</span><span class="p">(</span><span class="n">Q</span><span class="p">).</span><span class="n">squeeze</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">device</span><span class="p">)</span>   <span class="c1"># qval
</span>
      <span class="c1"># get current policy
</span>      <span class="n">m</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">distributions</span><span class="p">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">logits</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">actor</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
      <span class="c1"># get the policy ratio
</span>      <span class="n">ratio_p</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">exp</span><span class="p">(</span><span class="n">m</span><span class="p">.</span><span class="n">log_prob</span><span class="p">(</span><span class="n">p_i</span><span class="p">))</span> <span class="o">/</span> <span class="n">p_k</span>

      <span class="c1"># get critic value
</span>      <span class="n">V</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">critic</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="n">squeeze</span><span class="p">()</span>

      <span class="c1"># calculating advantage function A = Q - V
</span>      <span class="n">A</span> <span class="o">=</span> <span class="n">Q</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">critic</span><span class="p">(</span><span class="n">s</span><span class="p">).</span><span class="n">squeeze</span><span class="p">()</span>
      <span class="c1"># normalize the advantages
</span>      <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span> <span class="o">-</span> <span class="n">A</span><span class="p">.</span><span class="n">mean</span><span class="p">())</span> <span class="o">/</span> <span class="p">(</span><span class="n">A</span><span class="p">.</span><span class="n">std</span><span class="p">()</span> <span class="o">+</span> <span class="mf">1e-7</span><span class="p">)</span> <span class="c1"># the 1e-7 is there to avoid dividing by 0
</span>      <span class="c1"># lose the gradient portion
</span>      <span class="n">A</span> <span class="o">=</span> <span class="n">A</span><span class="p">.</span><span class="n">detach</span><span class="p">()</span>


      <span class="c1"># the PPO-clip objective function i.e. step 6 of the algo
</span>      <span class="n">objective</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="nb">min</span><span class="p">(</span><span class="n">ratio_p</span> <span class="o">*</span> <span class="n">A</span><span class="p">,</span>
                            <span class="n">torch</span><span class="p">.</span><span class="n">clamp</span><span class="p">(</span><span class="n">ratio_p</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="bp">self</span><span class="p">.</span><span class="n">clip</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">clip</span><span class="p">)</span> <span class="o">*</span> <span class="n">A</span><span class="p">)</span>

      <span class="c1"># param update losses
</span>      <span class="c1"># actor param loss
</span>      <span class="n">loss_actor</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">objective</span> <span class="o">+</span> <span class="p">(</span><span class="mf">1e-2</span> <span class="o">*</span> <span class="n">m</span><span class="p">.</span><span class="n">entropy</span><span class="p">())).</span><span class="n">mean</span><span class="p">()</span>

      <span class="c1"># critic param loss i.e. step 7 of the algo (MSE suffices here)
</span>      <span class="n">loss_critic</span> <span class="o">=</span> <span class="p">((</span><span class="n">V</span> <span class="o">-</span> <span class="n">Q</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">).</span><span class="n">mean</span><span class="p">()</span>

      <span class="c1"># calculate gradients and perform backward propagation for networks
</span>      <span class="n">loss_actor</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">optimr_actor</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">optimr_actor</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
      <span class="n">loss_critic</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">optimr_critic</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
      <span class="bp">self</span><span class="p">.</span><span class="n">optimr_critic</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>

      <span class="c1"># append params
</span>      <span class="n">losses_actor</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_actor</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>
      <span class="n">losses_critic</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">loss_critic</span><span class="p">.</span><span class="n">item</span><span class="p">())</span>

    <span class="c1"># return mean with the new update
</span>    <span class="n">n_losses_actor</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_actor</span><span class="p">)</span>
    <span class="n">n_losses_critic</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_critic</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_actor</span><span class="p">),</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">losses_critic</span><span class="p">)</span>
</code></pre></div></div>

<p>###<strong>Replay Buffer</strong></p>

<p>adapted from PPO from scratch tutorial</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">collections</span>

<span class="c1">#       s, _, p_i, p_k, r, _, Q, done = replay[indices]
</span><span class="n">Data</span> <span class="o">=</span> <span class="n">collections</span><span class="p">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s">'Data'</span><span class="p">,</span> <span class="s">'s a p_i p_k r s_p Q done'</span><span class="p">)</span>

<span class="c1"># simple buffer type list
</span><span class="k">class</span> <span class="nc">Buffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">max_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">val</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">max_size</span> <span class="o">=</span> <span class="n">max_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">buffer</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="p">.</span><span class="n">max_size</span><span class="p">,)</span> <span class="o">+</span> <span class="bp">self</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="p">.</span><span class="n">val</span><span class="p">.</span><span class="n">dtype</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">buffer</span><span class="p">[</span><span class="bp">self</span><span class="p">.</span><span class="n">position</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">position</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">position</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_size</span>
        <span class="bp">self</span><span class="p">.</span><span class="nb">len</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="nb">buffer</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">max_size</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="nb">len</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ReplayBuffer</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">buffers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">max_size</span> <span class="o">=</span> <span class="n">max_size</span>

    <span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">buffers</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_size</span>

    <span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">data</span><span class="p">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">buffers</span><span class="p">:</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">max_size</span><span class="p">)</span>

            <span class="bp">self</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">key</span><span class="p">].</span><span class="n">add</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">Data</span><span class="p">.</span><span class="n">_fields</span><span class="p">:</span>
            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">buffers</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">idx</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">lens</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">buffers</span><span class="p">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">lens</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">min</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span> <span class="o">==</span> <span class="nb">max</span><span class="p">(</span><span class="n">lens</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">lens</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</code></pre></div></div>

<p>###<strong>Rollout Data</strong></p>

<p>Rollout logic taken from the gym env reference and the original rollout code.</p>

<p><strong>NOTE:</strong> This is where the video gets saved, change here to change video file name</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">ray</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">deque</span>
<span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">ImageDraw</span>
<span class="kn">import</span> <span class="nn">imageio</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Video</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>


<span class="k">class</span> <span class="nc">Rollout</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">GraphicsConfig</span><span class="p">.</span><span class="n">ld</span><span class="p">()</span>
        <span class="n">config</span><span class="p">.</span><span class="n">screen_width</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="n">config</span><span class="p">.</span><span class="n">screen_height</span> <span class="o">=</span> <span class="mi">64</span>
        <span class="c1">#pystk.clean() # just in case you crash and couldn't terminate the program
</span>        <span class="n">pystk</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="n">race_config</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">RaceConfig</span><span class="p">()</span>
        <span class="n">race_config</span><span class="p">.</span><span class="n">players</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">controller</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">PlayerConfig</span><span class="p">.</span><span class="n">Controller</span><span class="p">.</span><span class="n">PLAYER_CONTROL</span>
        <span class="n">race_config</span><span class="p">.</span><span class="n">track</span> <span class="o">=</span> <span class="n">track</span>
        <span class="n">race_config</span><span class="p">.</span><span class="n">step_size</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># pytux race setup
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">race</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Race</span><span class="p">(</span><span class="n">race_config</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

        <span class="c1"># pytux track start
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">track</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Track</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">rollout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                <span class="n">policy</span><span class="p">:</span> <span class="n">BasePolicy</span><span class="p">,</span>
                <span class="n">max_step</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">frame_skip</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>

        <span class="c1"># always make sure to restart the track environment!
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">restart</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">WorldState</span><span class="p">()</span>
        <span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">r_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">distance_down_track</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">render_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">image</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">off_track</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">traveled</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_step</span><span class="p">):</span>
            <span class="c1"># Early termination
</span>            <span class="c1"># depends on being off the track and not moving
</span>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">median</span><span class="p">(</span><span class="n">traveled</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">off_track</span><span class="p">)):</span>
                <span class="k">break</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">velocity</span><span class="p">)</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">action_i</span><span class="p">,</span> <span class="n">p_action</span> <span class="o">=</span> <span class="n">policy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">):</span>
                <span class="n">action_op</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">.</span><span class="n">steer</span><span class="p">,</span> <span class="n">action</span><span class="p">.</span><span class="n">acceleration</span><span class="p">,</span> <span class="n">action</span><span class="p">.</span><span class="n">drift</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">action_op</span> <span class="o">=</span> <span class="n">action</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">()</span>
                <span class="n">action</span><span class="p">.</span><span class="n">steer</span> <span class="o">=</span> <span class="n">action_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">action</span><span class="p">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">action_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="n">action</span><span class="p">.</span><span class="n">drift</span> <span class="o">=</span> <span class="n">action_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">frame_skip</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">WorldState</span><span class="p">()</span>
                <span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">s_p</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">render_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">image</span><span class="p">)</span>
            <span class="n">d_new</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">distance_down_track</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mf">5.0</span><span class="p">)</span>
            <span class="n">node_idx</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">searchsorted</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">path_distance</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>
                    <span class="n">d_new</span> <span class="o">%</span> <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">path_distance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">%</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">path_nodes</span><span class="p">)</span>
            <span class="n">a_b</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">path_nodes</span><span class="p">[</span><span class="n">node_idx</span><span class="p">]</span>
            <span class="n">distance</span> <span class="o">=</span> <span class="n">point_from_line</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">location</span><span class="p">,</span> <span class="n">a_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a_b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">distance_traveled</span> <span class="o">=</span> <span class="n">get_distance</span><span class="p">(</span><span class="n">d_new</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">path_distance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
            <span class="n">gain</span> <span class="o">=</span> <span class="n">distance_traveled</span> <span class="k">if</span> <span class="n">distance_traveled</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span>
            <span class="n">mult</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">6.0</span><span class="p">)</span>
            <span class="n">traveled</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">gain</span><span class="p">)</span>
            <span class="n">off_track</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">distance</span> <span class="o">&gt;</span> <span class="mf">6.0</span><span class="p">)</span>

            <span class="n">r_total</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">r_total</span><span class="p">,</span> <span class="n">d_new</span> <span class="o">*</span> <span class="n">mult</span><span class="p">)</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="nb">max</span><span class="p">(</span><span class="n">mult</span> <span class="o">*</span> <span class="n">gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">mult</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

            <span class="c1"># print when the kart finished the track (if it was able to)
</span>            <span class="k">if</span> <span class="n">np</span><span class="p">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">overall_distance</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">2e-3</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">'Finished at: t=%d'</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>

            <span class="n">result</span><span class="p">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">Data</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">copy</span><span class="p">(),</span>
                         <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">(</span><span class="n">action_op</span><span class="p">),</span>
                         <span class="n">np</span><span class="p">.</span><span class="n">uint8</span><span class="p">([</span><span class="n">action_i</span><span class="p">]),</span>
                         <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">p_action</span><span class="p">]),</span>
                         <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">r</span><span class="p">]),</span>
                         <span class="n">s_p</span><span class="p">.</span><span class="n">copy</span><span class="p">(),</span>
                         <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">np</span><span class="p">.</span><span class="n">nan</span><span class="p">]),</span>
                         <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="mi">0</span><span class="p">])))</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">d_new</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s_p</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">reversed</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span>
            <span class="n">G</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">r</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">G</span>
            <span class="c1"># collections.namedtuple('Data', 's a p_i p_k r s_p Q done')
</span>            <span class="n">result</span><span class="p">[</span><span class="o">-</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">Data</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">s</span><span class="p">,</span>
                                    <span class="n">data</span><span class="p">.</span><span class="n">a</span><span class="p">,</span>
                                    <span class="n">data</span><span class="p">.</span><span class="n">p_i</span><span class="p">,</span>
                                    <span class="n">data</span><span class="p">.</span><span class="n">p_k</span><span class="p">,</span>
                                    <span class="n">data</span><span class="p">.</span><span class="n">r</span><span class="p">,</span>
                                    <span class="n">data</span><span class="p">.</span><span class="n">s_p</span><span class="p">,</span>
                                    <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">G</span><span class="p">]),</span>
                                    <span class="n">np</span><span class="p">.</span><span class="n">float32</span><span class="p">([</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]))</span>

        <span class="k">return</span> <span class="n">result</span><span class="p">[</span><span class="mi">4</span><span class="p">:],</span> <span class="p">(</span><span class="n">r_total</span> <span class="o">/</span> <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">path_distance</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>


    <span class="k">def</span> <span class="nf">rollout_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">policy</span><span class="p">:</span> <span class="n">BasePolicy</span><span class="p">,</span> <span class="n">max_step</span><span class="p">,</span> <span class="n">frame_skip</span><span class="p">,</span> <span class="n">gamma</span><span class="p">):</span>
        <span class="n">COLAB_IMAGES</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="c1"># always make sure to restart the track environment!
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">restart</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">())</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">WorldState</span><span class="p">()</span>
        <span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
        <span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">r_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">distance_down_track</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">render_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">image</span><span class="p">)</span>
        <span class="n">G</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">off_track</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">traveled</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_step</span><span class="p">):</span>
            <span class="c1"># Early termination
</span>            <span class="c1"># depends on being off the track and not moving
</span>            <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">median</span><span class="p">(</span><span class="n">traveled</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">0.05</span> <span class="ow">or</span> <span class="nb">all</span><span class="p">(</span><span class="n">off_track</span><span class="p">)):</span>
                <span class="k">break</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">linalg</span><span class="p">.</span><span class="n">norm</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">karts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">velocity</span><span class="p">)</span>
            <span class="n">action</span><span class="p">,</span> <span class="n">action_i</span><span class="p">,</span> <span class="n">p_action</span> <span class="o">=</span> <span class="n">policy</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">):</span>
                <span class="n">action_op</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">.</span><span class="n">steer</span><span class="p">,</span> <span class="n">action</span><span class="p">.</span><span class="n">acceleration</span><span class="p">,</span> <span class="n">action</span><span class="p">.</span><span class="n">drift</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">action_op</span> <span class="o">=</span> <span class="n">action</span>
                <span class="n">action</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">Action</span><span class="p">()</span>
                <span class="n">action</span><span class="p">.</span><span class="n">steer</span> <span class="o">=</span> <span class="n">action_op</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">action</span><span class="p">.</span><span class="n">acceleration</span> <span class="o">=</span> <span class="n">np</span><span class="p">.</span><span class="n">clip</span><span class="p">(</span><span class="n">action_op</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="p">.</span><span class="n">inf</span><span class="p">)</span>
                <span class="n">action</span><span class="p">.</span><span class="n">drift</span> <span class="o">=</span> <span class="n">action_op</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.5</span>

            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">frame_skip</span><span class="p">):</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">step</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
                <span class="bp">self</span><span class="p">.</span><span class="n">track</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>
                <span class="n">state</span> <span class="o">=</span> <span class="n">pystk</span><span class="p">.</span><span class="n">WorldState</span><span class="p">()</span>
                <span class="n">state</span><span class="p">.</span><span class="n">update</span><span class="p">()</span>

            <span class="n">image</span> <span class="o">=</span> <span class="n">Image</span><span class="p">.</span><span class="n">fromarray</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">race</span><span class="p">.</span><span class="n">render_data</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">image</span><span class="p">)</span>
            <span class="n">COLAB_IMAGES</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="p">.</span><span class="n">array</span><span class="p">(</span><span class="n">image</span><span class="p">))</span>
            <span class="n">clip</span> <span class="o">=</span> <span class="n">ImageSequenceClip</span><span class="p">(</span><span class="n">COLAB_IMAGES</span><span class="p">,</span> <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="s">'eval.mp4'</span>
            <span class="n">clip</span><span class="p">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">clip</span><span class="p">.</span><span class="n">ipython_display</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span>


    <span class="k">def</span> <span class="nf">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1">#self.race.stop()
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">race</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">track</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="n">pystk</span><span class="p">.</span><span class="n">clean</span><span class="p">()</span>


<span class="c1"># makes Rollout compatible with Ray
</span><span class="o">@</span><span class="n">ray</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="n">num_cpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">RayRollout</span><span class="p">(</span><span class="n">Rollout</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="n">N_WORKERS_CPU</span> <span class="o">=</span> <span class="mi">8</span> <span class="c1"># how many cpu for ray you specified in main
</span><span class="k">class</span> <span class="nc">RaySampler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">track</span><span class="o">=</span><span class="s">'hacienda'</span><span class="p">):</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">rollouts</span> <span class="o">=</span> <span class="p">[</span><span class="n">RayRollout</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="n">track</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N_WORKERS_CPU</span><span class="p">)]</span>
        <span class="c1">#self.rollouts_eval = RayRollout.remote(track) # Ray doesn't like having multiple ray.remote objects at once
</span>
    <span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">max_frames</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">frame_skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">total_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">video_rollouts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">total_frames</span> <span class="o">&lt;=</span> <span class="n">max_frames</span><span class="p">:</span>
            <span class="n">batch_ros</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">rollout</span> <span class="ow">in</span> <span class="bp">self</span><span class="p">.</span><span class="n">rollouts</span><span class="p">:</span>
                <span class="n">batch_ros</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">rollout</span><span class="p">.</span><span class="n">rollout</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span>
                                                        <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">,</span>
                                                        <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                                        <span class="n">frame_skip</span><span class="o">=</span><span class="n">frame_skip</span><span class="p">))</span>
            <span class="n">batch_ros</span> <span class="o">=</span> <span class="n">ray</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch_ros</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_rollouts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">:</span>
                <span class="n">video_rollouts</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ro</span> <span class="k">for</span> <span class="n">ro</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">batch_ros</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">total_frames</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ro</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame_skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ro</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">batch_ros</span><span class="p">)</span>
            <span class="n">returns</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ret</span> <span class="k">for</span> <span class="n">ro</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">batch_ros</span><span class="p">])</span>

            <span class="k">yield</span> <span class="n">batch_ros</span>

        <span class="k">print</span><span class="p">(</span><span class="s">'Total Frames: %d'</span> <span class="o">%</span> <span class="p">(</span><span class="n">total_frames</span><span class="p">))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Episodes: %d'</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">returns</span><span class="p">)))</span>
        <span class="k">print</span><span class="p">(</span><span class="s">'Return: %.3f'</span> <span class="o">%</span> <span class="n">np</span><span class="p">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">))</span>

        <span class="c1"># try to use video_rollouts to show stuff
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"videos:"</span><span class="p">,</span> <span class="n">make_video</span><span class="p">(</span><span class="n">video_rollouts</span><span class="p">).</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># (time, channel, height, width)
</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">prepare_video</span><span class="p">(</span><span class="n">make_video</span><span class="p">(</span><span class="n">video_rollouts</span><span class="p">))</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">ImageSequenceClip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tensor</span><span class="p">),</span> <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">'scotland.mp4'</span>
        <span class="n">clip</span><span class="p">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">clip</span><span class="p">.</span><span class="n">ipython_display</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="c1"># TODO: figure out why/how to make this play in output whilst training
</span>
    <span class="c1"># BROKEN
</span>    <span class="k">def</span> <span class="nf">get_samples_eval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">agent</span><span class="p">,</span> <span class="n">max_frames</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">frame_skip</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">total_frames</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
        <span class="n">video_rollouts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

        <span class="k">while</span> <span class="n">total_frames</span> <span class="o">&lt;=</span> <span class="n">max_frames</span><span class="p">:</span>
            <span class="n">batch_ros</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="n">batch_ros</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">rollouts_eval</span><span class="p">.</span><span class="n">rollout</span><span class="p">.</span><span class="n">remote</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span>
                                                        <span class="n">max_step</span><span class="o">=</span><span class="n">max_step</span><span class="p">,</span>
                                                        <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                                        <span class="n">frame_skip</span><span class="o">=</span><span class="n">frame_skip</span><span class="p">))</span>
            <span class="c1">#print('batch_rollouts: ', batch_ros)
</span>            <span class="n">batch_ros</span> <span class="o">=</span> <span class="n">ray</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">batch_ros</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">video_rollouts</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">:</span>
                <span class="n">video_rollouts</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ro</span> <span class="k">for</span> <span class="n">ro</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">batch_ros</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ro</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>

            <span class="n">total_frames</span> <span class="o">+=</span> <span class="nb">sum</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ro</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame_skip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ro</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">batch_ros</span><span class="p">)</span>
            <span class="n">returns</span><span class="p">.</span><span class="n">extend</span><span class="p">([</span><span class="n">ret</span> <span class="k">for</span> <span class="n">ro</span><span class="p">,</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">batch_ros</span><span class="p">])</span>

            <span class="k">yield</span> <span class="n">batch_ros</span>

        <span class="c1"># try to use video_rollouts to show stuff
</span>        <span class="k">print</span><span class="p">(</span><span class="s">"videos:"</span><span class="p">,</span> <span class="n">make_video</span><span class="p">(</span><span class="n">video_rollouts</span><span class="p">).</span><span class="n">shape</span><span class="p">)</span> <span class="c1"># (time, channel, height, width)
</span>
        <span class="n">tensor</span> <span class="o">=</span> <span class="n">prepare_video</span><span class="p">(</span><span class="n">make_video</span><span class="p">(</span><span class="n">video_rollouts</span><span class="p">))</span>
        <span class="n">clip</span> <span class="o">=</span> <span class="n">ImageSequenceClip</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tensor</span><span class="p">),</span> <span class="n">fps</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="s">'eval.mp4'</span>
        <span class="n">clip</span><span class="p">.</span><span class="n">write_videofile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">clip</span><span class="p">.</span><span class="n">ipython_display</span><span class="p">(</span><span class="n">width</span> <span class="o">=</span> <span class="mi">256</span><span class="p">)</span> <span class="c1"># TODO: figure out why/how to make this play in output whilst training
</span></code></pre></div></div>

<p>#<strong>MAIN</strong>
Configs and actually learning!</p>

<p>Ray Ref:
[https://docs.ray.io/en/latest/ray-observability/ray-metrics.html#ray-metrics ]</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="c1"># Ray trainer
</span>    <span class="n">trainer</span> <span class="o">=</span> <span class="p">{</span><span class="s">'ppo'</span><span class="p">:</span> <span class="n">PPO</span><span class="p">}[</span><span class="n">config</span><span class="p">[</span><span class="s">'algorithm'</span><span class="p">]](</span><span class="o">**</span><span class="n">config</span><span class="p">)</span>

    <span class="n">sampler</span> <span class="o">=</span> <span class="n">RaySampler</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'track'</span><span class="p">])</span>
    <span class="n">replay</span> <span class="o">=</span> <span class="n">ReplayBuffer</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'max_frames'</span><span class="p">])</span>

    <span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s">'max_epoch'</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"</span><span class="se">\033</span><span class="s">[1m"</span> <span class="o">+</span> <span class="s">'EPOCH: '</span> <span class="o">+</span> <span class="s">"</span><span class="se">\033</span><span class="s">[0m"</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">rollout_batch</span> <span class="ow">in</span> <span class="n">sampler</span><span class="p">.</span><span class="n">get_samples</span><span class="p">(</span><span class="n">trainer</span><span class="p">.</span><span class="n">get_policy</span><span class="p">(</span><span class="n">epoch</span><span class="p">),</span> <span class="o">**</span><span class="n">config</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">rollout</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">rollout_batch</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">rollout</span><span class="p">:</span>
                    <span class="n">replay</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># metrics from ray trainer based on the current replay from the buffer
</span>        <span class="c1"># of which the replay buffer will be used by the PPO to train
</span>        <span class="n">trainer</span><span class="p">.</span><span class="n">train</span><span class="p">(</span><span class="n">replay</span><span class="p">)</span>

        <span class="c1"># save final few epoch trained model (don't want to save all the premature ones)
</span>        <span class="k">if</span> <span class="n">epoch</span> <span class="o">%</span> <span class="mi">50</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
          <span class="n">model_save_name</span> <span class="o">=</span> <span class="s">'controller.th'</span>
          <span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s">"/content/drive/MyDrive/</span><span class="si">{</span><span class="n">model_save_name</span><span class="si">}</span><span class="s">"</span>
          <span class="n">torch</span><span class="p">.</span><span class="n">save</span><span class="p">(</span><span class="n">trainer</span><span class="p">.</span><span class="n">actor</span><span class="p">.</span><span class="n">state_dict</span><span class="p">(),</span> <span class="n">path</span><span class="p">)</span>

</code></pre></div></div>

<p><strong>NOTE:</strong>
Besides the parameters listed here, the performance is also affected by the range of values for the actions in the discretized policy class. This is due to the discretization being rather gross. -&gt; limiting max acceleration seems to help for some reason</p>

<p><strong>NOTE:</strong>
Be sure to change the saved .mp4 fileâ€™s name in the RaySampler class to whatever the track name is</p>

<p><strong>PPO Best Practices:</strong>
[https://github.com/llSourcell/Unity_ML_Agents/blob/master/docs/best-practices-ppo.md ]</p>

<p>Return should continue to increase per epoch if training is going well!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">config</span> <span class="o">=</span> <span class="p">{</span><span class="s">'algorithm'</span><span class="p">:</span> <span class="s">'ppo'</span><span class="p">,</span> <span class="c1"># letting ray trainer know which algo we wanna go with
</span>          <span class="s">'track'</span><span class="p">:</span> <span class="s">'scotland'</span><span class="p">,</span> <span class="c1"># pytuxkart track name
</span>          <span class="s">'frame_skip'</span> <span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
          <span class="s">'max_frames'</span><span class="p">:</span> <span class="mi">10000</span><span class="p">,</span> <span class="c1"># Essentially works as max buffer in our case, should be a multiple of batch_size (larger means more stable training apparently)
</span>          <span class="s">'max_step'</span> <span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="c1"># how many steps of the simulation are run through training (more steps for more complex problems)
</span>          <span class="s">'gamma'</span><span class="p">:</span> <span class="mf">0.9</span><span class="p">,</span> <span class="c1"># discount factor
</span>          <span class="s">'max_epoch'</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="c1"># number of passes through the whole dataset
</span>          <span class="s">'device'</span><span class="p">:</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">'cuda'</span><span class="p">),</span> <span class="c1"># if no cuda, change to 'cpu'
</span>          <span class="s">'batch_size'</span><span class="p">:</span> <span class="mi">512</span><span class="p">,</span> <span class="c1"># number of samples processed before the model is updated (power of 2)
</span>          <span class="s">'iters'</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span> <span class="c1"># number of times a batch is passed through [10-100]
</span>          <span class="s">'learn_r'</span><span class="p">:</span> <span class="mf">5e-4</span><span class="p">,</span> <span class="c1"># correspond to strength of each gradient descent update step
</span>          <span class="s">'clip'</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="c1"># acceptable threshold of divergence b/w old &amp; new policies
</span>          <span class="s">'eps'</span><span class="p">:</span> <span class="mf">0.10</span><span class="p">,</span> <span class="c1"># helps with exploration (higher #) vs exploitation (lower #)
</span>          <span class="p">}</span>

<span class="c1"># checking prev. ray node status
# NOTE: if running for the first time comment this out
#! ray status
</span>
<span class="n">ray</span><span class="p">.</span><span class="n">shutdown</span><span class="p">()</span>
<span class="n">ray</span><span class="p">.</span><span class="n">init</span><span class="p">(</span><span class="n">num_gpus</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_cpus</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">ignore_reinit_error</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">main</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
</code></pre></div></div>

<p>#<strong>TODO: Evaluating Policy</strong></p>

<p>This section crashes the notebook often for some reason, no idea whyâ€¦</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">load_model</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">torch</span> <span class="kn">import</span> <span class="n">load</span>
    <span class="n">path</span> <span class="o">=</span> <span class="sa">F</span><span class="s">"/content/drive/MyDrive/RL_Final_Project/controller.th"</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">Network</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
    <span class="n">m</span><span class="p">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
    <span class="n">m</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">m</span>

<span class="k">def</span> <span class="nf">eval</span><span class="p">():</span>
  <span class="c1"># reworking...
</span>  <span class="n">rollout</span> <span class="o">=</span> <span class="n">Rollout</span><span class="p">(</span><span class="s">'lighthouse'</span><span class="p">)</span>
  <span class="n">rollout</span><span class="p">.</span><span class="n">rollout_eval</span><span class="p">(</span><span class="n">DiscretizedPolicy</span><span class="p">(</span><span class="n">load_model</span><span class="p">(),</span> <span class="mi">16</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">),</span> <span class="n">max_step</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">frame_skip</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.9</span><span class="p">)</span>

<span class="s">'''
eval()
'''</span>
</code></pre></div></div>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>'\neval()\n'
</code></pre></div></div>


            
          </p>
        </div>
      
		</div>
		<div id="footer">
  <div class="icons-wrap">
  
    <a href="https://github.com/RX-00" target="_blank"><i class="fab fa-github icon_link"></i></a>
  
    <a href="mailto:royx@bu.edu" target="_blank"><i class="far fa-envelope icon_link"></i></a>
  
    <a href="https://www.linkedin.com/in/roy-xing" target="_blank"><i class="fa fa-linkedin-square icon_link"></i></a>
  
  </div>
  <p>
    2020   Â·
    Roy Xing  Â·
    <a href="mailto:royx@bu.edu">Contact</a> 
  </p>
  
</div>

	</div>
    </body>
</html>
